"use strict";angular.module("HomeExpensesApp",["HomeExpensesApp.controllers","HomeExpensesApp.directives","HomeExpensesApp.filters","ui.router","ui.bootstrap","ngCsv"]).config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state({name:"addItem",url:"/addItem",views:{"":{templateUrl:"partials/addItem",controller:"AddItemCtrl"}}}),$stateProvider.state({name:"listItems",url:"/listItems",views:{"":{templateUrl:"partials/listItems",controller:"ListItemsCtrl"}}}),$stateProvider.state({name:"adminItems",url:"/adminItems",views:{"":{templateUrl:"partials/adminItems",controller:"AdminItemsCtrl"}}}),$stateProvider.state({name:"graph",url:"/graph",views:{"":{templateUrl:"partials/graph",controller:"GraphCtrl"}}}),$urlRouterProvider.otherwise("/addItem")}]).config(["$httpProvider","$compileProvider",function($httpProvider,$compileProvider){var elementsList=jQuery(),showMessage=function(content,cl,time){jQuery("<div/>").addClass("message").addClass(cl).hide().fadeIn("fast").delay(time).fadeOut("fast",function(){jQuery(this).remove()}).appendTo(elementsList).text(content)};$httpProvider.interceptors.push(function($timeout,$q){return{response:function(response){return response.config.method.toUpperCase()!="GET"&&showMessage("Success","successMessage",5e3),response},responseError:function(rejection){switch(rejection.status){case 401:showMessage("Wrong usename or password","errorMessage",2e4),$rootScope.$broadcast("event:no-session",{});break;case 403:showMessage("You don't have the right to do this","errorMessage",2e4);break;case 500:showMessage("Server internal error: "+rejection.data.error,"errorMessage",2e4);break;default:showMessage("Error "+rejection.status+": "+rejection.data.error,"errorMessage",2e4)}return $q.reject(rejection)}}}),$compileProvider.directive("appMessages",function(){var directiveDefinitionObject={link:function(scope,element,attrs){elementsList.push(jQuery(element))}};return directiveDefinitionObject})}]).config(["$locationProvider",function($locationProvider){$locationProvider.html5Mode({enabled:!1,requireBase:!1})}]),"use strict",angular.module("HomeExpensesApp.directives",[]).directive("appVersion",["version",function(version){return function(scope,elm,attrs){elm.text(version)}}]).directive("refreshList",function(){return{restrict:"A",link:function(scope,element,attrs){jQuery("li").removeClass("ui-li-static")}}}).directive("ngBlur",["$parse",function($parse){return function(scope,element,attr){var fn=$parse(attr.ngBlur);element.bind("blur",function(event){scope.$apply(function(){fn(scope,{$event:event})})})}}]).directive("smaTypeahead2",["$parse","$log",function($parse,$log){return{restrict:"A",require:"?ngModel",link:function postLink(scope,element,attrs,controller){var getter=$parse(attrs.smaTypeahead),setter=getter.assign,value=getter(scope);scope.$watch(attrs.smaTypeahead,function(newValue,oldValue){newValue!==oldValue&&(value=newValue)}),element.attr("data-provide","typeahead"),element.typeahead({source:function(query){return angular.isFunction(value)?value.apply(null,arguments):value},minLength:attrs.minLength||1,items:attrs.items,updater:function(value){return controller&&attrs.typeaheadUpdaterFunction&&scope.$apply(function(){scope[attrs.typeaheadUpdaterFunction](value)}),""}});var typeahead=element.data("typeahead");typeahead.$button=jQuery(jQuery.fn.typeahead.defaults.button),typeahead.$button.bind("click",function(event){scope.$apply(function(){scope[attrs.typeaheadUpdaterFunction]({name:element.val(),category:"Unknown",quantity:1})})}),typeahead.lookup=function(ev){var items;return this.query=this.$element.val()||"",this.query.length<this.options.minLength?this.shown?this.hide():this:(items=jQuery.isFunction(this.source)?this.source(this.query,jQuery.proxy(this.process,this)):this.source,items?this.process(items):this)},typeahead.matcher=function(item){return item.name.toLowerCase().slice(0,this.query.length)===this.query.toLowerCase()},typeahead.highlighter=function(item){return item.name},typeahead.render=function(items){var that=this;return items=jQuery(items).map(function(i,item){return i=jQuery(that.options.item).attr("data-value",JSON.stringify(item)),i.find("a").html(that.highlighter(item)),i[0]}),items.first().addClass("active"),this.$menu.html(items),this},typeahead.select=function(){var val=JSON.parse(this.$menu.find(".active").attr("data-value"));return this.$element.val(val.name).change(),this.updater(val),this.hide()},typeahead.sorter=function(items){var beginswith=[],caseSensitive=[],caseInsensitive=[],item;while(item=items.shift())item.name.toLowerCase().indexOf(this.query.toLowerCase())?~item.name.indexOf(this.query)?caseSensitive.push(item):caseInsensitive.push(item):beginswith.push(item);return beginswith.concat(caseSensitive,caseInsensitive)},typeahead.show=function(){var pos=jQuery.extend({},this.$element.position(),{height:this.$element[0].offsetHeight});return this.$menu.insertAfter(this.$element).css({top:pos.top+pos.height,left:pos.left}).show(),this.$button.insertAfter(this.$element).css({top:"18px"}).show(),this.shown=!0,this},attrs.minLength==="0"&&setTimeout(function(){element.on("focus",function(){setTimeout(element.typeahead.bind(element,"lookup"),200)})})}}}]).directive("smaTypeahead",["$compile","$log",function($compile,$log){return{restrict:"A",scope:{datasets:"=",eventHandler:"&ngClick"},compile:function(element,attrs){var template=angular.element('<span class="input-group-btn"><button class="btn btn-primary glyphicon glyphicon-ok-sign" ng-click="eventHandler()" /></span>'),lik=$compile(template);return function(scope,element){element.typeahead(scope.datasets),jQuery(".twitter-typeahead").addClass("input-group").css("display","table"),jQuery(".tt-hint").addClass("form-control"),jQuery(".tt-query").addClass("form-control").after(lik(scope))}}}}]).directive("smaPopover",["$compile","$log",function($compile,$log){return{restrict:"A",scope:{value:"=",listClick:"&"},transclude:!1,compile:function(element,attrs){var template='<div id="supermarkets" class="list-group"><button class="list-group-item" ng-repeat="supermarket in value" ng-click="selectSupermarket()">{{ supermarket.name }}</button></div>',compTpl=$compile(template);return function(scope,element){element.popover({html:!0,content:function(){return template},placement:"bottom"}).click(function(e){$compile(jQuery(".popover").contents())(scope)})}}}}]).directive("smaPopover2",["$log","$parse","$compile","$http","$timeout","$q","$templateCache",function($log,$parse,$compile,$http,$timeout,$q,$templateCache){return jQuery("body").on("keyup",function(ev){ev.keyCode===27&&jQuery(".popover.in").each(function(){jQuery(this).popover("hide")})}),{restrict:"A",scope:!1,compile:function(element,attr){var template=angular.element("#"+attr.contentRef)[0].innerHTML;return function postLink(scope,element,attr,ctrl){var getter=$parse(attr.bsPopover),setter=getter.assign,value=getter(scope),options={};angular.isObject(value)&&(options=value),angular.isObject(template)&&(template=template.data),!attr.unique||element.on("show",function(ev){jQuery(".popover.in").each(function(){var $this=jQuery(this),popover=$this.data("popover");popover&&!popover.$element.is(element)&&$this.popover("hide")})}),!attr.hide||scope.$watch(attr.hide,function(newValue,oldValue){newValue?popover.hide():newValue!==oldValue&&$timeout(function(){popover.show()})}),!attr.show||scope.$watch(attr.show,function(newValue,oldValue){newValue?$timeout(function(){popover.show()}):newValue!==oldValue&&popover.hide()}),element.popover(angular.extend({},options,{content:template,html:!0,placement:"bottom"}));var popover=element.data("bs.popover");popover.hasContent=function(){return this.getTitle()||template},popover.getPosition=function(){var r=jQuery.fn.popover.Constructor.prototype.getPosition.apply(this,arguments);return $compile(this.$tip)(scope),scope.$digest(),this.$tip.data("bs.popover",this),r},scope.$popover=function(name){$log.log(name),popover(name)},angular.forEach(["show","hide"],function(name){scope[name]=function(){popover[name]()}}),scope.dismiss=scope.hide,angular.forEach(["show.bs.popover","shown.bs.popover","hide.bs.popover","hidden.bs.popover"],function(name){element.on(name,function(ev){scope.$emit("popover-"+name,ev),name==="hidden.bs.popover"&&popover.$tip.css("display","none")})})}}}}]).directive("graph",["$log",function($log){return{restrict:"E",scope:{data:"=",options:"="},link:function(scope,element,attrs){scope.$watch("data",function(data){if(!scope.options)return;var svg=d3.select(element[0]).append("svg").attr("width",960).attr("height",500),margin={top:20,right:80,bottom:30,left:50},width=svg.attr("width")-margin.left-margin.right,height=svg.attr("height")-margin.top-margin.bottom,g=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")"),parseTime=d3.timeParse("%Y%m%d"),x=d3.scaleTime().range([0,width]),y=d3.scaleLinear().range([height,0]),z=d3.scaleOrdinal(d3.schemeCategory10),line=d3.line().curve(d3.curveBasis).x(function(d){return x(d[scope.options.keys.x])}).y(function(d){return y(d[scope.options.keys.y])});x.domain(scope.options.ranges.x),y.domain(scope.options.ranges.y),z.domain(scope.options.titles),g.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+height+")").call(d3.axisBottom(x)),g.append("g").attr("class","axis axis--y").call(d3.axisLeft(y)).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("fill","#000").text(scope.options.titles.y);var city=g.selectAll(".city").data(data).enter().append("g").attr("class","city");city.append("path").attr("class","line").attr("d",function(d){return line(d.values)}).style("stroke",function(d){return z(d.id)}),city.append("text").datum(function(d){return{id:d.id,value:d.values[d.values.length-1]}}).attr("transform",function(d){return"translate("+x(d.value.date)+","+y(d.value.price)+")"}).attr("x",3).attr("dy","0.35em").style("font","10px sans-serif").text(function(d){return d.id})})}}}]),"use strict",angular.module("HomeExpensesApp.filters",[]).filter("interpolate",["version",function(version){return function(text){return String(text).replace(/\%VERSION\%/mg,version)}}]).filter("countPending",[function(){return function(items){return _.reduce(items,function(memo,item){return item.purchased?memo:memo+1},0)}}]).filter("sumPrices",[function(){return function(items){return _.reduce(items,function(memo,item){return memo+item.price},0)}}]).filter("orderObjectBy",["$log","$filter",function($log,$filter){return function(input,order){if(!order)return input;$log.log("orderObjectBy");var output=[],supermarketCategories,uk,tmp,end=[];return supermarketCategories=order.categories,_.each(supermarketCategories,function(category){tmp=_.filter(input,function(cat){return cat.category===category})[0],tmp&&($filter("countPending")(tmp.items)>0?output.push(tmp):end.push(tmp))}),uk=_.filter(input,function(cat){return cat.category==="Unknown"})[0],uk&&output.push(uk),end.length>0&&(output=output.concat(end)),output}}]).filter("groupByCategory",["$log","$filter",function($log,$filter){return function(input){return $log.log("groupByCategory"),_.groupBy(input,"category")}}]).filter("formatDate",["$log",function($log){return function(input){return moment(input,"YYYY-MM-DD").format("DD/MM/YYYY")}}]).filter("formatPrice",["$log",function($log){return function(input){return Number((input/100).toFixed(2)).toLocaleString()}}]),"use strict",angular.module("HomeExpensesApp.controllers",["HomeExpensesApp.services"]).controller("AddItemCtrl",["$scope","$log","ItemServices",function($scope,$log,ItemServices){ItemServices.getCategories(function(categories){$scope.categoryList=categories.categories}),$scope.init=function(){$log.log(moment.locale()),$scope.item={date:new Date}},$scope.init(),$scope.addItem=function(){$scope.item.price=Math.floor($scope.item.priceStr*100),ItemServices.addItem($scope.item,function(){$scope.init()})},$scope.validatePrice=function(){var i,newValue=$scope.item.priceStr;if(!newValue)return;(i=newValue.indexOf(","))<=0?$scope.item.priceStr=newValue+",00":$scope.item.priceStr=newValue},$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0},$scope.dateOptions={"starting-day":1}}]).controller("ListItemsCtrl",["$scope","$log","ItemServices",function($scope,$log,ItemServices){$scope.header=[],$scope.data=[],$scope.dateList=[];var m;for(var i=0;i<6;i++)m=moment().subtract(i,"M"),$scope.dateList.push({val:new Date(m.format("D MMMM, YYYY")),text:m.format("MM/YYYY")});$scope.filterDate=$scope.dateList[0],$scope.init=function(){ItemServices.getGroupedItemsByDate($scope.filterDate.val,function(data){$scope.groupedItems=data.items,$scope.header=_.keys($scope.groupedItems);var tmp=[],it;_.each($scope.groupedItems,function(items,key){it=_.reduce(items,function(memo,item){return memo+item.price/100},0),tmp.push(Number(it.toFixed(2)).toLocaleString())}),$scope.data=[tmp]})},$scope.init(),$scope.$watch("filterDate",function(newValue){$scope.init()})}]).controller("AdminItemsCtrl",["$scope","$log","ItemServices",function($scope,$log,ItemServices){$scope.init=function(){ItemServices.listItems(function(data){$scope.items=data})},$scope.removeItem=function(id){$log.log(id),ItemServices.removeItem(id,function(){$scope.init()})},$scope.init()}]).controller("GraphCtrl",["$scope","$log","ItemServices",function($scope,$log,ItemServices){var parseTime=d3.timeParse("%Y-%m-%d");$scope.init=function(){ItemServices.getItemsArrayGroupedByCategory(parseTime("2016-10-20"),function(data){$scope.data=_.map(data.items,function(item){return{id:item.id,values:_.map(item.values,function(value){return{date:parseTime(value.date),price:value.price/100}})}});var maxArray=[],minArray=[];_.each($scope.data,function(obj){maxArray.push(_.max(obj.values,function(value){return value.price}).price),minArray.push(_.min(obj.values,function(value){return value.date}).date)}),$scope.options={ranges:{x:[_.min(minArray),new Date],y:[0,_.max(maxArray)]},keys:{x:"date",y:"price"},titles:{lines:_.keys($scope.data),y:"Euros"}}})},$scope.init()}]),"use strict",angular.module("HomeExpensesApp.services",[]).factory("ItemServices",["$log","$http","$q","$rootScope",function($log,$http,$q,$rootScope){return{addItem:function(item,callback){$http.post("/api/item/",{item:item}).success(function(data){callback()})},getCategories:function(callback){$http.get("/api/categories/").success(function(data){callback(data)})},listItems:function(callback){$http.get("/api/items/").success(function(data){callback(data.items)})},removeItem:function(id,callback){$http["delete"]("/api/item/"+id).success(function(data){callback(data)})},getGroupedItemsByDate:function(date,callback){var start=moment(date).startOf("month").format("YYYY-MM-DD"),end=moment(date).add(1,"M").startOf("month").format("YYYY-MM-DD");$http.get("/api/itemsByCategory",{params:{from:start,to:end}}).success(function(data){callback(data)})},getItemsArrayGroupedByCategory:function(date,callback){var start=moment(date).startOf("year").format("YYYY-MM-DD"),end=moment(date).add(1,"Y").startOf("year").format("YYYY-MM-DD");$http.get("/api/itemsArrayByCategory",{params:{from:start,to:end}}).success(function(data){callback(data)})}}}]);